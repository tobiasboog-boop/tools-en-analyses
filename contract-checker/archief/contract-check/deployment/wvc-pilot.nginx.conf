# Nginx configuratie voor WVC Contract Checker Pilot
# 
# INSTALLATIE:
# 1. Kopieer dit bestand naar VPS4:
#    scp wvc-pilot.conf root@vps4:/etc/nginx/sites-available/
#
# 2. Maak symlink:
#    ln -s /etc/nginx/sites-available/wvc-pilot.conf /etc/nginx/sites-enabled/
#
# 3. Maak wachtwoord aan voor WVC:
#    htpasswd -c /etc/nginx/.htpasswd-wvc wvc_user
#
# 4. Test config:
#    nginx -t
#
# 5. Reload nginx:
#    systemctl reload nginx
#
# 6. SSL certificaat (na DNS is ingesteld):
#    certbot --nginx -d wvc-pilot.notifica.nl
#
# ============================================================================

server {
    server_name wvc-pilot.notifica.nl;

    # Basic Authentication
    auth_basic "WVC Contract Checker";
    auth_basic_user_file /etc/nginx/.htpasswd-wvc;

    # Streamlit proxy
    location / {
        proxy_pass http://127.0.0.1:8501;
        proxy_http_version 1.1;
        
        # WebSocket support (nodig voor Streamlit)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts (Streamlit kan langzaam zijn bij classificatie)
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # Streamlit static files
    location /_stcore/static {
        proxy_pass http://127.0.0.1:8501/_stcore/static;
    }

    location /_stcore/stream {
        proxy_pass http://127.0.0.1:8501/_stcore/stream;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
    }

    # Health check endpoint (geen auth nodig)
    location /healthz {
        auth_basic off;
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    # HTTP - wordt door certbot aangepast naar HTTPS
    listen 80;
}


# ============================================================================
# TOEKOMSTIG: Na migratie naar app.notifica.nl
# ============================================================================
# 
# Vervang bovenstaande config door deze redirect:
#
# server {
#     server_name wvc-pilot.notifica.nl;
#     return 301 https://app.notifica.nl/apps/werkbon-checker$request_uri;
#     
#     listen 443 ssl;
#     ssl_certificate /etc/letsencrypt/live/wvc-pilot.notifica.nl/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/wvc-pilot.notifica.nl/privkey.pem;
# }
